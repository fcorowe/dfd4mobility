[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Using Digital Footprint Data to Measure and Monitor Human Mobility",
    "section": "",
    "text": "Welcome\nThis website hosts the materials for the workshop “Using Digital Footprint Data to Measure and Monitor Human Mobility”. This training workshop was designed and is delivered by Prof. Francisco Rowe, Dr. Carmen Cabrera-Arnau, Dr. Miguel González-Leonardo, Ruth Neville and Andrea Nasuto.\nThe website is free to use and is licensed under the Attribution-NonCommercial-NoDerivatives 4.0 International. \n\n\n\n\n\n\nContact\n\nProf. Francisco Rowe, Professor in Population Data Science\nf.rowe-gonzalez [at] liverpool.ac.uk\nDepartment of Geography and Planning, University of Liverpool, Liverpool, UK\n\n\nDr Carmen Cabrera-Arnau, Lecturer in Geographic Data Science\nc.cabrera-arnau [at] liverpool.ac.uk\nDepartment of Geography and Planning, University of Liverpool, Liverpool, UK\n\n\nDr Miguel Gonzalez-Leonardo, Assistant Professor\nmiguel.gonzalez [at] colmex.mx\nCenter for Demographic, Urban and Environmental Studies, El Colegio de Mexico, Mexico City, Mexico\n\n\nRuth Neville, PhD candidate\nruth.neville [at] liverpool.ac.uk\nDepartment of Geography and Planning, University of Liverpool, Liverpool, UK\n\n\nAndrea Nasuto, PhD candidate\nandrea.nasuto [at] liverpool.ac.uk\nDepartment of Geography and Planning, University of Liverpool, Liverpool, UK"
  },
  {
    "objectID": "overview.html#description",
    "href": "overview.html#description",
    "title": "Overview",
    "section": "Description",
    "text": "Description\nThis workshop offers an introduction to the use of digital footprint data from Meta-Facebook to analyse internal population movements. We will cover how to use location data collected via digital technology to develop data products to analyse human mobility. We will also illustrate how these data can be used to create statistical indicators and geographic data visualisations to extract insightful information, monitor mobility trends and identify key areas of origin and destination. The workshop will use an applied, hands-on approach in R via computational notebooks."
  },
  {
    "objectID": "overview.html#structure",
    "href": "overview.html#structure",
    "title": "Overview",
    "section": "Structure",
    "text": "Structure\n\n\n\n\n\n\n\nTime\nActivity\n\n\n\n\n9.00-9.30\nRegistration and welcome coffee\n\n\n9.30-10.30\nDigital Footprint Data overview\n\n\n10.30-10.40\nComfort break\n\n\n10.40-11.40\nMeta-Facebook data introduction\n\n\n11.40-12.15\nSoftware installation and preparation for practical session\n\n\n12.15-13.15\nLunch break\n\n\n13.15-14.30\nExploring temporal patterns of human mobility\n\n\n14.30-15.00\nCoffee break\n\n\n15.00-16.30\nExploring spatial patterns of human mobility\n\n\n16.30-17.00\nQ&A"
  },
  {
    "objectID": "overview.html#before-the-workshop",
    "href": "overview.html#before-the-workshop",
    "title": "Overview",
    "section": "Before the workshop",
    "text": "Before the workshop\n\n\n\n\n\n\nImportant\n\n\n\nPlease make sure you download and install the most recent version of R, RStudio and Quarto on the computer that you will be using during the workshop, and install the indicated R packages – see detailed instructions below.\n\n\n\n\n\n\n\n\nNote\n\n\n\nAll three software packages are open and free to use.\n\n\nR\nYou can download R here. Make sure you select the appropriate version for your Operating System: Windows, MacOS (Apple silicon M1/M2 or older intel Macs). For example, if you use a macOS laptop with an M1 processor, click on ‘Download R for macOS’ and then, click the link to download the installer file (.pkg extension for macOS) under the header ‘For Apple silicon (M1/M2) Macs’. You can then open the installer and follow the instructions that you will be prompted with. For Windows users, click on ‘install R for the first time’ and follow the prompts.\nRStudio\nYou will also need to download RStudio Desktop (or simply RStudio), which is an integrated development environment to help you write code in R more easily. To download RStudio, follow this link and scroll down to the section titled ‘All Installers and Tarballs’. Download the appropriate installer file according to your Operating System. Then, open the installer and follow the installation instructions that you will be prompted with.\nQuarto\nDownload Quarto from this website. Quarto is a publishing system that will allow you to open and work on the computational notebooks for the workshop. On ‘Step 1’ on the website, download the version of Quarto that matches your Operating System. Open the installer file, run it and follow the prompts.\nR libraries\nOnce you have installed R, you will need to install some R extensions, known as packages, that will be useful for the applications explored in this workshop. The packages you need to install are:\n\ntidyverse\nggthemes\npatchwork\nviridis\ntmap\nsf\nsp\nstringr\nRColorBrewer\n\nTo install the packages, open RStudio. On the console window (normally at the bottom left), write the following command: install.packages(“name of package”). Make sure you replace “name of package” by the actual name of the package that you want to install e.g. install.packages(“tidyverse”). Then, press enter and repeat this process until you have installed all the packages in the list.\n\n\n\n\n\n\nNote\n\n\n\nWe might ask you to install more packages on the day that this workshop is taking place."
  },
  {
    "objectID": "overview.html#during-the-workshop",
    "href": "overview.html#during-the-workshop",
    "title": "Overview",
    "section": "During the workshop",
    "text": "During the workshop\nAll the workshop material will be made available on this website which is currently under construction. Further instructions on how to download the material will be given during the workshop."
  },
  {
    "objectID": "spatial-patterns.html#aims",
    "href": "spatial-patterns.html#aims",
    "title": "Spatial patterns",
    "section": "Aims",
    "text": "Aims"
  },
  {
    "objectID": "spatial-patterns.html#dependencies",
    "href": "spatial-patterns.html#dependencies",
    "title": "Spatial patterns",
    "section": "Dependencies",
    "text": "Dependencies\n\n#clean environment\nrm(list=ls())\n\n# data wrangling\nlibrary(tidyverse)\n#library(fs)\n#library(here)\n\n# spatial data wrangling\nlibrary(sf)\nlibrary(mapdeck)\n\n# data visualisation\nlibrary(viridis) \n#library(viridisLite)\nlibrary(ggthemes)\nlibrary(patchwork)\nlibrary(showtext)\nlibrary(gganimate)\n#library(gifski)\n#library(ggnewscale)"
  },
  {
    "objectID": "spatial-patterns.html#data",
    "href": "spatial-patterns.html#data",
    "title": "Spatial patterns",
    "section": "Data",
    "text": "Data\n\nMeta-Facebook mobility data\nRead and describe Meta-Facebook mobility data\nData for April 2020\n\n# read\ndf20 <- readRDS(\"./data/fb/movement_adm/2020_04.rds\") %>% \n  dplyr::filter(country == \"CL\")\nglimpse(df20)\n\nRows: 29,491\nColumns: 20\n$ GEOMETRY                     <chr> \"LINESTRING (-69.96872527689874 -23.40113…\n$ date_time                    <chr> \"2020-04-01 00:00\", \"2020-04-01 00:00\", \"…\n$ start_polygon_id             <chr> \"60845\", \"60862\", \"60845\", \"60862\", \"6086…\n$ start_polygon_name           <chr> \"Antofagasta\", \"Cardenal Caro\", \"Antofaga…\n$ end_polygon_id               <chr> \"60847\", \"60890\", \"60846\", \"60863\", \"6089…\n$ end_polygon_name             <chr> \"Tocopilla\", \"Melipilla\", \"El Loa\", \"Colc…\n$ length_km                    <dbl> 139.7543134, 24.0764953, 100.3339392, 24.…\n$ tile_size                    <dbl> 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 1…\n$ country                      <chr> \"CL\", \"CL\", \"CL\", \"CL\", \"CL\", \"CL\", \"CL\",…\n$ level                        <chr> \"LEVEL3\", \"LEVEL3\", \"LEVEL3\", \"LEVEL3\", \"…\n$ n_crisis                     <dbl> 79, 18, 320, 71, NA, 369, NA, 20, 11, NA,…\n$ n_baseline                   <dbl> 59.50, 25.50, 671.00, 132.75, NA, 559.25,…\n$ n_difference                 <dbl> 19.50, -7.50, -351.00, -61.75, NA, -190.2…\n$ percent_change               <dbl> 32.231405, -28.301887, -52.232143, -46.16…\n$ is_statistically_significant <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ z_score                      <dbl> 2.0148470, -0.6837043, -4.0000000, -1.261…\n$ start_lat                    <dbl> -24.32798, -34.32667, -24.32798, -34.3266…\n$ start_lon                    <dbl> -69.56718, -71.78028, -69.56718, -71.7802…\n$ end_lat                      <dbl> -22.06894, -33.75413, -22.81611, -34.7036…\n$ end_lon                      <dbl> -69.60081, -71.19829, -68.20015, -71.0631…\n\n\n\nunique_origins <- unique(df20$start_polygon_name)\nunique_destinations <- unique(df20$end_polygon_name)\n\n\n\nBing tiles\nRead and describe Bing tile grids and how they can be created - reference to our work.\nR spatial ecosystem to handle spatial data frames.\n\nbing_grid <- read_sf(\"./data/shp/grid/chile_grid.shp\") %>% \n  st_simplify(preserveTopology =T,\n              dTolerance = 1000) %>%  # 1km\n  sf::st_make_valid()\n\n\n\n\n\n\n\n\nAdministrative areas\nRead and describe administrative areas. Explain spatial data frames: geometry, projection, etc.\n\nshp_adm <- read_sf(\"./data/shp/adm/gadm41_CHL_3.shp\") %>% \n  st_simplify(preserveTopology =T,\n              dTolerance = 1000) %>%  # 1km\n  sf::st_make_valid() %>% \n  dplyr::select( -c(\n    NL_NAME_1, NL_NAME_2, VARNAME_3, NL_NAME_3, CC_3, HASC_3\n  ) )\n\nshp_adm\n\nSimple feature collection with 345 features and 10 fields (with 1 geometry empty)\nGeometry type: GEOMETRY\nDimension:     XY\nBounding box:  xmin: -109.4488 ymin: -55.97871 xmax: -66.41821 ymax: -17.49952\nGeodetic CRS:  WGS 84\n# A tibble: 345 × 11\n   GID_3       GID_0 COUNTRY GID_1   NAME_1 GID_2 NAME_2 NAME_3 TYPE_3 ENGTYPE_3\n   <chr>       <chr> <chr>   <chr>   <chr>  <chr> <chr>  <chr>  <chr>  <chr>    \n 1 CHL.2.1.1_1 CHL   Chile   CHL.2_1 Antof… CHL.… Antof… Antof… Comuna Municipa…\n 2 CHL.2.1.2_1 CHL   Chile   CHL.2_1 Antof… CHL.… Antof… Mejil… Comuna Municipa…\n 3 CHL.2.1.3_1 CHL   Chile   CHL.2_1 Antof… CHL.… Antof… Sierr… Comuna Municipa…\n 4 CHL.2.1.4_1 CHL   Chile   CHL.2_1 Antof… CHL.… Antof… Taltal Comuna Municipa…\n 5 CHL.2.2.1_1 CHL   Chile   CHL.2_1 Antof… CHL.… El Loa Calama Comuna Municipa…\n 6 CHL.2.2.2_1 CHL   Chile   CHL.2_1 Antof… CHL.… El Loa Ollag… Comuna Municipa…\n 7 CHL.2.2.3_1 CHL   Chile   CHL.2_1 Antof… CHL.… El Loa San P… Comuna Municipa…\n 8 CHL.2.3.1_1 CHL   Chile   CHL.2_1 Antof… CHL.… Tocop… María… Comuna Municipa…\n 9 CHL.2.3.2_1 CHL   Chile   CHL.2_1 Antof… CHL.… Tocop… Tocop… Comuna Municipa…\n10 CHL.3.1.1_1 CHL   Chile   CHL.3_1 Arauc… CHL.… Cautín Carah… Comuna Municipa…\n# ℹ 335 more rows\n# ℹ 1 more variable: geometry <POLYGON [°]>"
  },
  {
    "objectID": "spatial-patterns.html#spatial-indicators-of-human-mobility",
    "href": "spatial-patterns.html#spatial-indicators-of-human-mobility",
    "title": "Spatial patterns",
    "section": "Spatial indicators of human mobility",
    "text": "Spatial indicators of human mobility\n\nOrigin-based indicators\nThis measure is in relation to a baseline - percentage change and flow\n\norigin_df <- df20 %>% \n  filter(start_polygon_name != end_polygon_name) %>% \n  group_by(start_polygon_name) %>% \n  dplyr::summarise(\n    mean_perchange = mean(percent_change, na.rm = T),\n    mean_diff_flow = mean(n_difference, na.rm = T),\n    sum_diff_flow = sum(n_difference, na.rm = T),\n    mean_outflow = mean(n_crisis, na.rm = T),\n    sum_outflow = sum(n_crisis, na.rm = T)\n    ) %>% \n  ungroup()\n\ntail(origin_df, 10)\n\n# A tibble: 10 × 6\n   start_polygon_name mean_perchange mean_diff_flow sum_diff_flow mean_outflow\n   <chr>                       <dbl>          <dbl>         <dbl>        <dbl>\n 1 Santiago                   -70.6         -792.      -1309523.         612. \n 2 Talagante                  -33.8         -263.       -127657.         269. \n 3 Talca                      -52.4         -150.        -70768          115. \n 4 Tamarugal                   24.0          -53.0        -7261.          90.8\n 5 Tierra del Fuego           -76.7          -19.8         -119.          12.2\n 6 Tocopilla                  147.            -4.23        -702.          38.5\n 7 Valdivia                   -75.8         -234.        -65400.          48.3\n 8 Valparaíso                 -62.3         -350.       -257762.         169. \n 9 Ñuble                      -62.5         -165.        -56482.          60.4\n10 Última Esperanza             1.77         -21.4          -21.4         10  \n# ℹ 1 more variable: sum_outflow <dbl>\n\n\n\n\nDestination-based indicators\n\ndestination_df <- df20 %>% \n  filter(start_polygon_name != end_polygon_name) %>% \n  group_by(end_polygon_name) %>% \n  dplyr::summarise(\n    mean_perchange = mean(percent_change, na.rm = T),\n    mean_diff_flow = mean(n_difference, na.rm = T),\n    sum_diff_flow = sum(n_difference, na.rm = T),\n    mean_inflow = mean(n_crisis, na.rm = T),\n    sum_inflow = sum(n_crisis, na.rm = T)\n    ) %>% \n  ungroup()\n\ntail(destination_df, 10)\n\n# A tibble: 10 × 6\n   end_polygon_name mean_perchange mean_diff_flow sum_diff_flow mean_inflow\n   <chr>                     <dbl>          <dbl>         <dbl>       <dbl>\n 1 Santiago                  -72.1       -850.        -1336029.       639. \n 2 Talagante                 -30.3       -266.         -128140        273. \n 3 Talca                     -52.1       -147.          -68827        117. \n 4 Tamarugal                  30.0        -49.4          -7360.        88.9\n 5 Tierra del Fuego          -68.3        -16             -112         13.1\n 6 Tocopilla                  63.3         -0.899         -165.        36.6\n 7 Valdivia                  -71.2       -230.          -63284.        48.2\n 8 Valparaíso                -66.2       -341.         -245913.       170. \n 9 Ñuble                     -63.1       -158.          -57870.        58.0\n10 Última Esperanza          -12.8        NaN                0        NaN  \n# ℹ 1 more variable: sum_inflow <dbl>\n\n\n\n\nIntraflows\n\norigin_df <- df20 %>% \n  filter(start_polygon_name == end_polygon_name) %>% \n  group_by(start_polygon_name) %>% \n  dplyr::summarise(\n    mean_perchange = mean(percent_change, na.rm = T),\n    mean_diff_flow = mean(n_difference, na.rm = T),\n    sum_diff_flow = sum(n_difference, na.rm = T),\n    mean_intraflow = mean(n_crisis, na.rm = T),\n    sum_intraflow = sum(n_crisis, na.rm = T)\n    ) %>% \n  ungroup()\n\ntail(origin_df, 10)\n\n# A tibble: 10 × 6\n   start_polygon_name mean_perchange mean_diff_flow sum_diff_flow mean_intraflow\n   <chr>                       <dbl>          <dbl>         <dbl>          <dbl>\n 1 Santiago                    6.00         32253.       2902809.        585443 \n 2 Talagante                  24.0           3776.        339841.         19627.\n 3 Talca                       4.48          1479.        133093.         34622.\n 4 Tamarugal                 -15.4           -612.        -55063.          3342.\n 5 Tierra del Fuego            1.62            13.6         1228.           886.\n 6 Tocopilla                  14.5            121.         10931            976.\n 7 Valdivia                  -10.6          -2895.       -260512.         24506.\n 8 Valparaíso                 -1.27         -1295.       -116524.        101255.\n 9 Ñuble                      -0.441         -158.        -14207.         36391.\n10 Última Esperanza          -18.7           -164.        -14750.           712.\n# ℹ 1 more variable: sum_intraflow <dbl>\n\n\n\n\nNetflows\n\n# mean outflow by area\noutflows_df <- df20 %>% \n  filter(start_polygon_name != end_polygon_name) %>% \n  group_by(start_polygon_name) %>% \n  dplyr::summarise(\n    mean_outflow = mean(n_crisis, na.rm = T)\n    ) %>% \n  ungroup()\n\n# mean inflow by area\ninflows_df <- df20 %>% \n  filter(start_polygon_name != end_polygon_name) %>% \n  group_by(end_polygon_name) %>% \n  dplyr::summarise(\n    mean_inflow = mean(n_crisis, na.rm = T)\n    ) %>% \n  ungroup()\n\n# combine data frames\nnetflow_df <- cbind(inflows_df, outflows_df)\n\n# mean netflow by area\nnetflow_df <- netflow_df %>% \n  mutate(\n    mean_netflow = mean_inflow - mean_outflow\n  ) %>% \n  select(start_polygon_name, end_polygon_name, mean_inflow, mean_outflow, mean_netflow)\n\nhead(netflow_df)\n\n  start_polygon_name end_polygon_name mean_inflow mean_outflow mean_netflow\n1        Antofagasta      Antofagasta    63.27513     66.00571    -2.730582\n2             Arauco           Arauco    91.14286     93.48276    -2.339901\n3              Arica            Arica    17.44444     20.16379    -2.719349\n4              Aysen            Aysen    28.47297     27.15385     1.319127\n5            Bío-Bío          Bío-Bío    77.86880     79.00000    -1.131195\n6          Cachapoal        Cachapoal   110.54008    112.71988    -2.179800\n\n\n\nggplot(data = netflow_df) +\n  geom_density(aes(x = mean_netflow),\n               alpha=0.5, \n               colour=\"darkblue\", \n               linewidth = 2\n               ) +\n  theme_tufte()"
  },
  {
    "objectID": "spatial-patterns.html#mapping",
    "href": "spatial-patterns.html#mapping",
    "title": "Spatial patterns",
    "section": "Mapping",
    "text": "Mapping\nColour palettes\n\n\n\n\n\n\nQuestion 1\n\n\n\nWhy to create geovisualisations?\n\n\nFor creating maps, cartography is important. A carefully crafted map can be an effective way of communicating complex information. Design issues include poor placement, size and readability of text and careless selection of colors. Have a look the style guide of the Journal of Maps for details.\n\n\n\n\n\n\nNote\n\n\n\nFor colour palettes, we recommend the following resources:\n\nthe R packages viridis and RColorBrewer\nthe website color brewer 2.0\na publication by Crameri, Shephard, and Heron (2020)\n\n\n\n\nHandling spatial data\n\n# set crs\ncrs_default = \"EPSG:4326\"\n\n\ndf20 <- readRDS(\"./data/fb/movement_adm/2020_04.rds\") %>% \n  mutate(GEOMETRY = NULL) %>% \n  dplyr::filter(country == \"CL\") %>% \n  st_as_sf(coords = c(\"start_lon\", \"start_lat\"), \n                                      crs = crs_default)\n\nglimpse(df20)\n\nRows: 29,491\nColumns: 18\n$ date_time                    <chr> \"2020-04-01 00:00\", \"2020-04-01 00:00\", \"…\n$ start_polygon_id             <chr> \"60845\", \"60862\", \"60845\", \"60862\", \"6086…\n$ start_polygon_name           <chr> \"Antofagasta\", \"Cardenal Caro\", \"Antofaga…\n$ end_polygon_id               <chr> \"60847\", \"60890\", \"60846\", \"60863\", \"6089…\n$ end_polygon_name             <chr> \"Tocopilla\", \"Melipilla\", \"El Loa\", \"Colc…\n$ length_km                    <dbl> 139.7543134, 24.0764953, 100.3339392, 24.…\n$ tile_size                    <dbl> 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 1…\n$ country                      <chr> \"CL\", \"CL\", \"CL\", \"CL\", \"CL\", \"CL\", \"CL\",…\n$ level                        <chr> \"LEVEL3\", \"LEVEL3\", \"LEVEL3\", \"LEVEL3\", \"…\n$ n_crisis                     <dbl> 79, 18, 320, 71, NA, 369, NA, 20, 11, NA,…\n$ n_baseline                   <dbl> 59.50, 25.50, 671.00, 132.75, NA, 559.25,…\n$ n_difference                 <dbl> 19.50, -7.50, -351.00, -61.75, NA, -190.2…\n$ percent_change               <dbl> 32.231405, -28.301887, -52.232143, -46.16…\n$ is_statistically_significant <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ z_score                      <dbl> 2.0148470, -0.6837043, -4.0000000, -1.261…\n$ end_lat                      <dbl> -22.06894, -33.75413, -22.81611, -34.7036…\n$ end_lon                      <dbl> -69.60081, -71.19829, -68.20015, -71.0631…\n$ geometry                     <POINT [°]> POINT (-69.56718 -24.32798), POINT …\n\n\n\nshp_adm <- read_sf(\"./data/shp/adm/gadm41_CHL_3.shp\") %>% \n  st_simplify(preserveTopology =T,\n              dTolerance = 1000) %>%  # 1km\n  sf::st_make_valid() %>% \n  dplyr::select( c(\n    NAME_3, \n    ENGTYPE_3, \n    geometry\n  ) ) %>% \n  st_transform(crs_default)\n\nshp_adm\n\nSimple feature collection with 345 features and 2 fields (with 1 geometry empty)\nGeometry type: GEOMETRY\nDimension:     XY\nBounding box:  xmin: -109.4488 ymin: -55.97871 xmax: -66.41821 ymax: -17.49952\nGeodetic CRS:  WGS 84\n# A tibble: 345 × 3\n   NAME_3               ENGTYPE_3                                       geometry\n * <chr>                <chr>                                      <POLYGON [°]>\n 1 Antofagasta          Municipality ((-70.60031 -23.4473, -70.60352 -23.46711,…\n 2 Mejillones           Municipality ((-70.02407 -23.06381, -69.98062 -22.95599…\n 3 Sierra Gorda         Municipality ((-68.69855 -23.92313, -68.69079 -23.85126…\n 4 Taltal               Municipality ((-70.4239 -24.61988, -70.56963 -24.55613,…\n 5 Calama               Municipality ((-68.01055 -22.03307, -68.19283 -21.90586…\n 6 Ollagüe              Municipality ((-68.05991 -21.77872, -68.18056 -21.60407…\n 7 San Pedro de Atacama Municipality ((-67.18149 -22.8142, -67.61008 -22.90392,…\n 8 María Elena          Municipality ((-69.96878 -22.86768, -69.53614 -22.88021…\n 9 Tocopilla            Municipality ((-70.26542 -22.62504, -69.96545 -22.42489…\n10 Carahue              Municipality ((-73.06431 -38.47689, -73.10936 -38.44577…\n# ℹ 335 more rows\n\n\nRecompute \n\n# mean outflow by area\noutflows_df <- df20 %>% \n  filter(start_polygon_name != end_polygon_name) %>% \n  group_by(start_polygon_name) %>% \n  dplyr::summarise(\n    mean_outflow = mean(n_crisis, na.rm = T)\n    ) %>% \n  ungroup()\n\n# mean inflow by area\ninflows_df <- df20 %>% \n  filter(start_polygon_name != end_polygon_name) %>% \n  group_by(end_polygon_name) %>% \n  dplyr::summarise(\n    mean_inflow = mean(n_crisis, na.rm = T)\n    ) %>% \n  ungroup() %>% \n  st_drop_geometry()\n\n# combine data frames\nnetflow_df <- cbind(outflows_df, inflows_df)\n\n# mean netflow by area\nnetflow_df <- netflow_df %>% \n  mutate(\n    mean_netflow = mean_inflow - mean_outflow\n  ) %>% \n  dplyr::select(start_polygon_name, mean_inflow, mean_outflow, mean_netflow, geometry) %>% \n  rename(\n    polygon_name = start_polygon_name\n  ) \n\nhead(netflow_df)\n\nSimple feature collection with 6 features and 4 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -73.58022 ymin: -45.45868 xmax: -69.56718 ymax: -18.71308\nGeodetic CRS:  WGS 84\n  polygon_name mean_inflow mean_outflow mean_netflow\n1  Antofagasta    63.27513     66.00571    -2.730582\n2       Arauco    91.14286     93.48276    -2.339901\n3        Arica    17.44444     20.16379    -2.719349\n4        Aysen    28.47297     27.15385     1.319127\n5      Bío-Bío    77.86880     79.00000    -1.131195\n6    Cachapoal   110.54008    112.71988    -2.179800\n                     geometry\n1 POINT (-69.56718 -24.32798)\n2  POINT (-73.3454 -37.72772)\n3 POINT (-69.85541 -18.71308)\n4 POINT (-73.58022 -45.45868)\n5 POINT (-71.92786 -37.53828)\n6  POINT (-70.7088 -34.28421)\n\nnrow(netflow_df)\n\n[1] 51\n\n\n\nggplot() + \n  geom_sf(data = shp_adm,\n          color = \"gray60\", \n          size = 0.1) +\n  geom_point(data = netflow_df,\n    aes(geometry = geometry),\n    stat = \"sf_coordinates\"\n  ) \n\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\n\n\n\n\n\nbbox_new <- st_bbox(shp_adm) # current bounding box\n\nxrange <- bbox_new$xmax - bbox_new$xmin # range of x values\nyrange <- bbox_new$ymax - bbox_new$ymin # range of y values\n\nbbox_new[1] <- bbox_new[1] + (0.6 * xrange) # xmin - left\n#bbox_new[3] <- bbox_new[3] + (0.5 * xrange) # xmax - right\n#bbox_new[2] <- bbox_new[2] - (0.5 * yrange) # ymin - bottom\n#bbox_new[4] <- bbox_new[4] + (0.5 * yrange) # ymax - top\n\nbbox_new <- bbox_new %>%  # take the bounding box ...\n  st_as_sfc() # ... and make it a sf polygon\n\nggplot() + \n  geom_sf(data = shp_adm,\n          color = \"gray60\", \n          size = 0.1) +\n  geom_point(data = netflow_df,\n    aes(geometry = geometry),\n    stat = \"sf_coordinates\",\n    size = .1\n  ) +\n  coord_sf(xlim = st_coordinates(bbox_new)[c(1,2),1], # min & max of x values\n           ylim = st_coordinates(bbox_new)[c(2,3),2]) + # min & max of y values\n  theme_void()\n\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\n\n\n\ntiff(\"./playground/origins_in_polygons.tiff\", width = 3200, height = 3000, res=300)\nlast_plot()\n\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\ndev.off()\n\nquartz_off_screen \n                2 \n\n\n\nmob_indicators <- st_join(shp_adm, netflow_df)\nmob_indicators\n\nSimple feature collection with 345 features and 6 fields (with 1 geometry empty)\nGeometry type: GEOMETRY\nDimension:     XY\nBounding box:  xmin: -109.4488 ymin: -55.97871 xmax: -66.41821 ymax: -17.49952\nGeodetic CRS:  WGS 84\n# A tibble: 345 × 7\n   NAME_3           ENGTYPE_3                  geometry polygon_name mean_inflow\n * <chr>            <chr>                 <POLYGON [°]> <chr>              <dbl>\n 1 Antofagasta      Municipa… ((-70.60031 -23.4473, -7… Antofagasta         63.3\n 2 Mejillones       Municipa… ((-70.02407 -23.06381, -… <NA>                NA  \n 3 Sierra Gorda     Municipa… ((-68.69855 -23.92313, -… <NA>                NA  \n 4 Taltal           Municipa… ((-70.4239 -24.61988, -7… <NA>                NA  \n 5 Calama           Municipa… ((-68.01055 -22.03307, -… <NA>                NA  \n 6 Ollagüe          Municipa… ((-68.05991 -21.77872, -… <NA>                NA  \n 7 San Pedro de At… Municipa… ((-67.18149 -22.8142, -6… El Loa              93.2\n 8 María Elena      Municipa… ((-69.96878 -22.86768, -… Tocopilla           36.6\n 9 Tocopilla        Municipa… ((-70.26542 -22.62504, -… <NA>                NA  \n10 Carahue          Municipa… ((-73.06431 -38.47689, -… <NA>                NA  \n# ℹ 335 more rows\n# ℹ 2 more variables: mean_outflow <dbl>, mean_netflow <dbl>\n\n\n\n# convert df to sf with linestring as geometry\ndf20 <- readRDS(\"./data/fb/movement_adm/2020_04.rds\") %>% \n  dplyr::filter(country == \"CL\") %>% \n  dplyr::select( -c(start_lat, start_lon, end_lat, end_lon))\n\n# extract geometry\n#geometry_vec <- st_geometry(shp_adm)\n\ncoordinates <- strsplit(df20$GEOMETRY, \"[\\\\(\\\\)]\")\n\n# Extract characters within parentheses\ncoordinate <- gsub(\"[\\\\(\\\\)]\", \n                   \"\", regmatches(df20$GEOMETRY, gregexpr(\"\\\\(.*?\\\\)\", df20$GEOMETRY))) %>%\n  as.data.frame() \n\ncoordinate$. <-  gsub(\",\",\"\", coordinate$.)\n\ncoord_geometry <-  separate(coordinate, col=., sep = \"\\\\s\", into = c(\"start_long\", \"start_lat\", \"end_long\", \"end_lat\"))\n\ndf20 <- cbind(df20, coord_geometry) %>% \n  mutate(GEOMETRY = NULL) %>% \n  st_as_sf(coords = c(\"start_long\", \"start_lat\"), \n                                      crs = crs_default)\n\n\n# mean outflow by area\noutflows_df <- df20 %>% \n  filter(start_polygon_name != end_polygon_name) %>% \n  group_by(start_polygon_name) %>% \n  dplyr::summarise(\n    mean_outflow = mean(n_crisis, na.rm = T)\n    ) %>% \n  ungroup()\n\n# mean inflow by area\ninflows_df <- df20 %>% \n  filter(start_polygon_name != end_polygon_name) %>% \n  group_by(end_polygon_name) %>% \n  dplyr::summarise(\n    mean_inflow = mean(n_crisis, na.rm = T)\n    ) %>% \n  ungroup() %>% \n  st_drop_geometry()\n\n# combine data frames\nnetflow_df <- cbind(outflows_df, inflows_df)\n\n# mean netflow by area\nnetflow_df <- netflow_df %>% \n  mutate(\n    mean_netflow = mean_inflow - mean_outflow\n  ) %>% \n  dplyr::select(start_polygon_name, mean_inflow, mean_outflow, mean_netflow, geometry) %>% \n  rename(\n    polygon_name = start_polygon_name\n  ) \n\nhead(netflow_df)\n\nSimple feature collection with 6 features and 4 fields\nGeometry type: MULTIPOINT\nDimension:     XY\nBounding box:  xmin: -73.74023 ymin: -45.52171 xmax: -69.05196 ymax: -18.39621\nGeodetic CRS:  WGS 84\n  polygon_name mean_inflow mean_outflow mean_netflow\n1  Antofagasta    63.27513     66.00571    -2.730582\n2       Arauco    91.14286     93.48276    -2.339901\n3        Arica    17.44444     20.16379    -2.719349\n4        Aysen    28.47297     27.15385     1.319127\n5      Bío-Bío    77.86880     79.00000    -1.131195\n6    Cachapoal   110.54008    112.71988    -2.179800\n                        geometry\n1 MULTIPOINT ((-70.40039 -25....\n2 MULTIPOINT ((-73.56445 -37....\n3 MULTIPOINT ((-70.22461 -18....\n4 MULTIPOINT ((-73.74023 -43....\n5 MULTIPOINT ((-72.68555 -36....\n6 MULTIPOINT ((-71.01562 -34....\n\nnrow(netflow_df)\n\n[1] 51\n\n\n\nbbox_new <- st_bbox(shp_adm) # current bounding box\n\nxrange <- bbox_new$xmax - bbox_new$xmin # range of x values\nyrange <- bbox_new$ymax - bbox_new$ymin # range of y values\n\nbbox_new[1] <- bbox_new[1] + (0.6 * xrange) # xmin - left\n#bbox_new[3] <- bbox_new[3] + (0.5 * xrange) # xmax - right\n#bbox_new[2] <- bbox_new[2] - (0.5 * yrange) # ymin - bottom\n#bbox_new[4] <- bbox_new[4] + (0.5 * yrange) # ymax - top\n\nbbox_new <- bbox_new %>%  # take the bounding box ...\n  st_as_sfc() # ... and make it a sf polygon\n\nggplot() + \n  geom_sf(data = shp_adm,\n          color = \"gray60\", \n          size = 0.1) +\n  geom_point(data = netflow_df,\n    aes(geometry = geometry),\n    stat = \"sf_coordinates\",\n    size = .1\n  ) +\n  coord_sf(xlim = st_coordinates(bbox_new)[c(1,2),1], # min & max of x values\n           ylim = st_coordinates(bbox_new)[c(2,3),2]) + # min & max of y values\n  theme_void()\n\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\n\n\n\ntiff(\"./playground/origins_in_polygons_v2.tiff\", width = 3200, height = 3000, res=300)\nlast_plot()\n\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\ndev.off()\n\nquartz_off_screen \n                2 \n\n\nJoin point-in-polygons\n\nOverlay start points from the mobility dataset over the polygons. Extract start points from the linestring geometry and use that to create the spatial data frame for mobility.\n\n\nmob_indicators <- st_join(shp_adm, netflow_df)\nmob_indicators\n\nSimple feature collection with 366 features and 6 fields (with 1 geometry empty)\nGeometry type: GEOMETRY\nDimension:     XY\nBounding box:  xmin: -109.4488 ymin: -55.97871 xmax: -66.41821 ymax: -17.49952\nGeodetic CRS:  WGS 84\n# A tibble: 366 × 7\n   NAME_3           ENGTYPE_3                  geometry polygon_name mean_inflow\n * <chr>            <chr>                 <POLYGON [°]> <chr>              <dbl>\n 1 Antofagasta      Municipa… ((-70.60031 -23.4473, -7… Antofagasta         63.3\n 2 Mejillones       Municipa… ((-70.02407 -23.06381, -… Antofagasta         63.3\n 3 Sierra Gorda     Municipa… ((-68.69855 -23.92313, -… Antofagasta         63.3\n 4 Taltal           Municipa… ((-70.4239 -24.61988, -7… Antofagasta         63.3\n 5 Calama           Municipa… ((-68.01055 -22.03307, -… El Loa              93.2\n 6 Ollagüe          Municipa… ((-68.05991 -21.77872, -… <NA>                NA  \n 7 San Pedro de At… Municipa… ((-67.18149 -22.8142, -6… El Loa              93.2\n 8 María Elena      Municipa… ((-69.96878 -22.86768, -… Tocopilla           36.6\n 9 Tocopilla        Municipa… ((-70.26542 -22.62504, -… <NA>                NA  \n10 Carahue          Municipa… ((-73.06431 -38.47689, -… Cautín              56.3\n# ℹ 356 more rows\n# ℹ 2 more variables: mean_outflow <dbl>, mean_netflow <dbl>\n\n\n\n\nChoropleths\nChoropleths are thematic maps. They are easy to create but also to get wrong. We will look at a set of the principles you can follow to create effective choropleth maps. Here three more questions to consider:\n\nWhat is being plotted?\nWhat is the target audience?\nWhat degree of interactivity we want to offer?\n\nMap flows - use code from uk migration paper\n\n# set categories\nmob_indicators <- mob_indicators %>% \n  mutate(\n    netflow_class = mean_netflow %>% cut(7, dig.lab = 3),\n    inflow_class = mean_inflow %>% cut(7, dig.lab = 3),\n    outflow_class = mean_outflow %>% cut(7, dig.lab = 3)\n  )\n\nmob_indicators$netflow_class %>% \n  summary()\n\n(-14.3,-8.46] (-8.46,-2.65]  (-2.65,3.16]   (3.16,8.97]   (8.97,14.8] \n            8            45           183            26             0 \n  (14.8,20.6]   (20.6,26.4]          NA's \n            0            19            85 \n\n\n\n# map netflows\nnetflow_plot <- ggplot(data = mob_indicators, aes(fill = netflow_class)) +\n  geom_sf(col = \"grey\", size = .1) +\n  coord_sf() +\n  scale_fill_brewer(palette = \"RdBu\", direction = -1) +\n  theme_map() +\n  theme(plot.title = element_text(size = 22, face = \"bold\"),\n        legend.position = \"none\") +\n  labs(title = \"(a) Net flow\",\n       fill = \"%\")\n\n# map inflows\ninflow_plot <- ggplot(data = mob_indicators, aes(fill = inflow_class)) +\n  geom_sf(col = \"grey\", size = .1) +\n  coord_sf() +\n  scale_fill_brewer(palette = \"PuRd\", direction = 1) +\n  theme_map() +\n  theme(plot.title = element_text(size = 22, face = \"bold\"),\n        legend.position = \"none\") +\n  labs(title = \"(b) Inflow\",\n       fill = \"%\")\n\n# map outflows\noutflow_plot <- ggplot(data = mob_indicators, aes(fill = outflow_class)) +\n  geom_sf(col = \"grey\", size = .1) +\n  coord_sf() +\n  scale_fill_brewer(palette = \"PuBu\", direction = 1) +\n  theme_map() +\n  theme(plot.title = element_text(size = 22, face = \"bold\"),\n        legend.position = \"none\") +\n  labs(title = \"(b) Outflow\",\n       fill = \"%\")\n\nnetflow_plot + inflow_plot + outflow_plot\n\n\n\n\n\n\n\nInteractive mapping\n\n\nFlow mapping\n\n\n\n\n\n\n\n\nCrameri, Fabio, Grace E. Shephard, and Philip J. Heron. 2020. “The Misuse of Colour in Science Communication.” Nature Communications 11 (1). https://doi.org/10.1038/s41467-020-19160-7."
  }
]