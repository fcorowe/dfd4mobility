{
  "hash": "759612431f16319b4b56bcce16c8bfa0",
  "result": {
    "markdown": "# Spatial patterns\n\n## Aims\n\n## Dependencies\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# data wrangling\nlibrary(tidyverse)\n#library(fs)\n#library(here)\n\n# spatial data wrangling\nlibrary(sf)\nlibrary(mapdeck)\n\n# data visualisation\nlibrary(viridis) \n#library(viridisLite)\nlibrary(ggthemes)\nlibrary(patchwork)\nlibrary(showtext)\nlibrary(gganimate)\n#library(gifski)\n#library(ggnewscale)\n```\n:::\n\n\n\n## Data\n\nRead and describe Meta-Facebook mobility data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf20 <- readRDS(\"./data/fb/movement_adm/2020_04.rds\") %>% \n  dplyr::filter(country == \"CL\")\nstr(df20)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nspc_tbl_ [29,491 x 20] (S3: spec_tbl_df/tbl_df/tbl/data.frame)\n $ GEOMETRY                    : chr [1:29491] \"LINESTRING (-69.96872527689874 -23.401130458751577, -69.64386372626582 -22.18049545774072)\" \"LINESTRING (-71.74072265625 -34.025285704448066, -71.49902343750001 -33.94332872030442)\" \"LINESTRING (-69.33584623247664 -23.384935392069348, -68.9607367114486 -22.551323233330702)\" \"LINESTRING (-71.72717786815069 -34.45899487647619, -71.49360552226027 -34.560277664097924)\" ...\n $ date_time                   : chr [1:29491] \"2020-04-01 00:00\" \"2020-04-01 00:00\" \"2020-04-01 00:00\" \"2020-04-01 00:00\" ...\n $ start_polygon_id            : chr [1:29491] \"60845\" \"60862\" \"60845\" \"60862\" ...\n $ start_polygon_name          : chr [1:29491] \"Antofagasta\" \"Cardenal Caro\" \"Antofagasta\" \"Cardenal Caro\" ...\n $ end_polygon_id              : chr [1:29491] \"60847\" \"60890\" \"60846\" \"60863\" ...\n $ end_polygon_name            : chr [1:29491] \"Tocopilla\" \"Melipilla\" \"El Loa\" \"Colchagua\" ...\n $ length_km                   : num [1:29491] 139.8 24.1 100.3 24.2 115.5 ...\n $ tile_size                   : num [1:29491] 11 11 11 11 11 11 11 11 11 11 ...\n $ country                     : chr [1:29491] \"CL\" \"CL\" \"CL\" \"CL\" ...\n $ level                       : chr [1:29491] \"LEVEL3\" \"LEVEL3\" \"LEVEL3\" \"LEVEL3\" ...\n $ n_crisis                    : num [1:29491] 79 18 320 71 NA 369 NA 20 11 NA ...\n $ n_baseline                  : num [1:29491] 59.5 25.5 671 132.8 NA ...\n $ n_difference                : num [1:29491] 19.5 -7.5 -351 -61.8 NA ...\n $ percent_change              : num [1:29491] 32.2 -28.3 -52.2 -46.2 166.7 ...\n $ is_statistically_significant: num [1:29491] 0 0 0 0 0 0 0 0 0 0 ...\n $ z_score                     : num [1:29491] 2.015 -0.684 -4 -1.261 1.5 ...\n $ start_lat                   : num [1:29491] -24.3 -34.3 -24.3 -34.3 -32.6 ...\n $ start_lon                   : num [1:29491] -69.6 -71.8 -69.6 -71.8 -70.7 ...\n $ end_lat                     : num [1:29491] -22.1 -33.8 -22.8 -34.7 -33.7 ...\n $ end_lon                     : num [1:29491] -69.6 -71.2 -68.2 -71.1 -70.9 ...\n - attr(*, \"spec\")=\n  .. cols(\n  ..   GEOMETRY = col_character(),\n  ..   date_time = col_character(),\n  ..   start_polygon_id = col_character(),\n  ..   start_polygon_name = col_character(),\n  ..   end_polygon_id = col_character(),\n  ..   end_polygon_name = col_character(),\n  ..   length_km = col_double(),\n  ..   tile_size = col_double(),\n  ..   country = col_character(),\n  ..   level = col_character(),\n  ..   n_crisis = col_double(),\n  ..   n_baseline = col_double(),\n  ..   n_difference = col_double(),\n  ..   percent_change = col_double(),\n  ..   is_statistically_significant = col_double(),\n  ..   z_score = col_double(),\n  ..   start_lat = col_double(),\n  ..   start_lon = col_double(),\n  ..   end_lat = col_double(),\n  ..   end_lon = col_double()\n  .. )\n - attr(*, \"problems\")=<externalptr> \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nunique_origins <- unique(df20$start_polygon_name)\nunique_destinations <- unique(df20$end_polygon_name)\n```\n:::\n\n\n\n### Bing tiles\n\nRead and describe Bing tile grids and how they can be created - reference to our work.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#bing_grid <- read_sf()\n```\n:::\n\n\n\n### Administrative areas\n\nRead and describe administrative areas. Explain spatial data frames: geometry, projection, etc.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nshp <- read_sf(\"./data/shp/gadm41_CHL_3.shp\") %>% \n  st_simplify(preserveTopology =T,\n              dTolerance = 1000) %>%  # 1km\n  sf::st_make_valid() %>% \n  dplyr::select( -c(\n    NL_NAME_1, NL_NAME_2, VARNAME_3, NL_NAME_3, CC_3, HASC_3\n  ) )\n\nshp\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 345 features and 10 fields (with 1 geometry empty)\nGeometry type: GEOMETRY\nDimension:     XY\nBounding box:  xmin: -109.4488 ymin: -55.97871 xmax: -66.41821 ymax: -17.49952\nGeodetic CRS:  WGS 84\n# A tibble: 345 x 11\n   GID_3       GID_0 COUNTRY GID_1   NAME_1 GID_2 NAME_2 NAME_3 TYPE_3 ENGTYPE_3\n   <chr>       <chr> <chr>   <chr>   <chr>  <chr> <chr>  <chr>  <chr>  <chr>    \n 1 CHL.2.1.1_1 CHL   Chile   CHL.2_1 Antof~ CHL.~ Antof~ Antof~ Comuna Municipa~\n 2 CHL.2.1.2_1 CHL   Chile   CHL.2_1 Antof~ CHL.~ Antof~ Mejil~ Comuna Municipa~\n 3 CHL.2.1.3_1 CHL   Chile   CHL.2_1 Antof~ CHL.~ Antof~ Sierr~ Comuna Municipa~\n 4 CHL.2.1.4_1 CHL   Chile   CHL.2_1 Antof~ CHL.~ Antof~ Taltal Comuna Municipa~\n 5 CHL.2.2.1_1 CHL   Chile   CHL.2_1 Antof~ CHL.~ El Loa Calama Comuna Municipa~\n 6 CHL.2.2.2_1 CHL   Chile   CHL.2_1 Antof~ CHL.~ El Loa Ollag~ Comuna Municipa~\n 7 CHL.2.2.3_1 CHL   Chile   CHL.2_1 Antof~ CHL.~ El Loa San P~ Comuna Municipa~\n 8 CHL.2.3.1_1 CHL   Chile   CHL.2_1 Antof~ CHL.~ Tocop~ María~ Comuna Municipa~\n 9 CHL.2.3.2_1 CHL   Chile   CHL.2_1 Antof~ CHL.~ Tocop~ Tocop~ Comuna Municipa~\n10 CHL.3.1.1_1 CHL   Chile   CHL.3_1 Arauc~ CHL.~ Cautín Carah~ Comuna Municipa~\n# i 335 more rows\n# i 1 more variable: geometry <POLYGON [°]>\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(shp$geometry)\n```\n\n::: {.cell-output-display}\n![](spatial-patterns_files/figure-pdf/unnamed-chunk-6-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## Spatial indicators of human mobility\n\n### Origin-based indicators\n\nThis measure is in relation to a baseline - percentage change and flow\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\norigin_df <- df20 %>% \n  group_by(start_polygon_name) %>% \n  dplyr::summarise(\n    mean_perchange = mean(percent_change, na.rm = T),\n    mean_flows = mean(n_difference, na.rm = T),\n    mean_outflow = mean(n_crisis, na.rm = T),\n    sum_flows = sum(n_difference, na.rm = T),\n    sum_outflow = sum(n_crisis, na.rm = T)\n    ) %>% \n  ungroup()\n\ntail(origin_df, 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10 x 6\n   start_polygon_name mean_perchange mean_flows mean_outflow sum_flows\n   <chr>                       <dbl>      <dbl>        <dbl>     <dbl>\n 1 Santiago                    -67.6      914.        30810.  1593286.\n 2 Talagante                   -27.3      368.         3294.   212183.\n 3 Talca                       -47.2      111.         5641.    62325.\n 4 Tamarugal                    15.1     -275.         1380.   -62324.\n 5 Tierra del Fuego            -22.9       11.6         832.     1109.\n 6 Tocopilla                   119.        40.0         368.    10228.\n 7 Valdivia                    -63.9     -883.         6014.  -325912.\n 8 Valparaíso                  -57.6     -453.        11183.  -374287.\n 9 Ñuble                       -54.1     -164.         7629.   -70690.\n10 Última Esperanza            -14.8     -162.          705.   -14771.\n# i 1 more variable: sum_outflow <dbl>\n```\n:::\n:::\n\n\n\n### Destination-based indicators\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndestination_df <- df20 %>% \n  group_by(end_polygon_name) %>% \n  dplyr::summarise(\n    mean_perchange = mean(percent_change, na.rm = T),\n    mean_flows = mean(n_difference, na.rm = T),\n    mean_outflow = mean(n_crisis, na.rm = T),\n    sum_flows = sum(n_difference, na.rm = T),\n    sum_outflow = sum(n_crisis, na.rm = T)\n    ) %>% \n  ungroup()\n\ntail(destination_df, 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10 x 6\n   end_polygon_name mean_perchange mean_flows mean_outflow sum_flows sum_outflow\n   <chr>                     <dbl>      <dbl>        <dbl>     <dbl>       <dbl>\n 1 Santiago                  -69.0      943.        32307.  1566780.    53693876\n 2 Talagante                 -24.2      371.         3324.   211701.     1897958\n 3 Talca                     -46.7      115.         5682.    64266.     3170655\n 4 Tamarugal                  18.8     -261.         1314.   -62423.      313993\n 5 Tierra del Fuego          -21.7       11.5         823.     1116.       79867\n 6 Tocopilla                  53.1       39.3         345.    10766.       94540\n 7 Valdivia                  -60.6     -887.         6079.  -323796.     2218811\n 8 Valparaíso                -61.3     -446.        11374.  -362437.     9235667\n 9 Ñuble                     -54.5     -158.         7229.   -72077.     3296434\n10 Última Esperanza          -17.7     -164.          712.   -14750.       64118\n```\n:::\n:::\n\n\n\n### Netflows\n\n## Mapping\n\n### Choropleths\n\n### Interactive mapping\n\n### Flow mapping\n\n## Common concepts\n\nThere are several concepts relevant to understanding the data sets. First of all, we construct maps using two different methods of identifying locations: tiles and administrative polygons.\n\nThe Bing Maps Tile System defines a series of grids at different resolution levels over a rectangular projection of the world (Schwartz 2018). Each level is constructed by dividing the previous level into fourths. We typically use Bing tile levels 13 through 16, where level 13 results in tiles that are about 4.9 x 4.9 km at the Equator. The other method we use for identifying a location is administrative polygons, which define the political and geographic boundaries of countries, states, provinces, counties, cities, and more.\n\nWhen generating a map for a crisis event, we specify a rectangular bounding box around the most directly affected area. The different map calculations, described in the following sections, are done relative to this region, and, for most of the maps, only data within this region is included. Most of the map types are based on counting events that occur within a time interval, which is frequently 8 or 24 hours. The time interval determines what data is included in a calculation as well as the minimum frequency with which new maps are generated.\n",
    "supporting": [
      "spatial-patterns_files/figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}